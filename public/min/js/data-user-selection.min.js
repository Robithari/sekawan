document.addEventListener("DOMContentLoaded",function(){function e(){const e=document.querySelector('#userForm input[name="_csrf"]');if(e&&e.value)return e.value;if(window.CSRF_TOKEN)return window.CSRF_TOKEN;const t=document.querySelector('meta[name="csrf-token"]');return t?t.content:""}const t=document.getElementById("user-action-loading"),n=document.getElementById("user-input-loading"),d=document.getElementById("user-section-message");function s(){t&&t.classList.remove("d-none")}function a(){t&&t.classList.add("d-none")}function r(){n&&n.classList.remove("d-none")}function o(){n&&n.classList.add("d-none")}function c(e,t){d&&(d.className="alert mb-3",d.classList.add("success"===e?"alert-success":"alert-danger"),d.textContent=t,d.classList.remove("d-none"),setTimeout(()=>d.classList.add("d-none"),3500))}const u=document.getElementById("menu-data-user"),i=document.getElementById("data-user-section");u&&i&&u.addEventListener("click",function(e){e.preventDefault(),document.querySelectorAll('section[id$="-section"]').forEach(e=>e.classList.add("d-none")),i.classList.remove("d-none")});let m=[];function l(e){const t=document.getElementById("user-tbody");t.innerHTML="",Array.isArray(e)&&0!==e.length?e.forEach((e,n)=>{const d=e.createdAt?"string"==typeof e.createdAt?new Date(e.createdAt):new Date(1e3*e.createdAt._seconds):null,s=d?d.toLocaleString("id-ID"):"-",a=document.createElement("tr");a.innerHTML=`\n                <td>${n+1}</td>\n                <td>${e.name||"-"}</td>\n                <td>${e.email||"-"}</td>\n                <td>${s}</td>\n                <td>${e.membershipCode||"-"}</td>\n                <td>${e.phoneNumber||"-"}</td>\n                <td>${e.fcmToken||"-"}</td>\n                <td>\n                    <button class="btn btn-sm btn-primary me-1" data-action="send" data-id="${e.id}" title="Kirim Pesan"><i class="bi bi-send"></i></button>\n                    <button class="btn btn-sm btn-warning me-1" data-action="edit" data-id="${e.id}" title="Edit"><i class="bi bi-pencil"></i></button>\n                    <button class="btn btn-sm btn-danger" data-action="delete" data-id="${e.id}" title="Hapus"><i class="bi bi-trash"></i></button>\n                </td>\n            `,t.appendChild(a)}):t.innerHTML='<tr><td colspan="8" class="text-center">Belum ada user terdaftar.</td></tr>'}document.getElementById("user-tbody").addEventListener("click",function(t){const n=t.target.closest("button");if(!n)return;const d=n.getAttribute("data-id"),r=n.getAttribute("data-action");"edit"===r?g(d):"delete"===r?function(e){y=e;const t=m.find(t=>t.id===e);document.getElementById("deleteUserId").value=e,document.getElementById("deleteUserName").textContent=t?t.name:"",document.getElementById("deleteUserEmail").textContent=t?t.email:"";new bootstrap.Modal(document.getElementById("deleteUserModal")).show()}(d):"send"===r&&async function(t){const n=m.find(e=>e.id===t);if(!n||!n.fcmToken||"-"===n.fcmToken)return void alert("User ini belum memiliki token FCM.");const d=prompt("Judul Pesan:");if(!d)return;const r=prompt("Isi Pesan:");if(!r)return;const o=e();s();try{const e=await fetch("/cms/data-user/send-fcm",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":o},body:JSON.stringify({token:n.fcmToken,title:d,body:r,_csrf:o})}),t=await e.json();a(),t.success?alert("Pesan berhasil dikirim!"):alert(t.error||"Gagal mengirim pesan")}catch(e){a(),alert("Terjadi error jaringan atau CSRF.")}}(d)});let y=null;function g(e){const t=m.find(t=>t.id===e);t&&(document.getElementById("userId").value=t.id,document.getElementById("userName").value=t.name||"",document.getElementById("userEmail").value=t.email||"",document.getElementById("userMembershipCode").value=t.membershipCode||"",document.getElementById("userPhoneNumber").value=t.phoneNumber||"",document.getElementById("userFcmToken").value=t.fcmToken||"",document.getElementById("user-add-btn").classList.add("d-none"),document.getElementById("user-update-btn").classList.remove("d-none"),document.getElementById("user-cancel-btn").classList.remove("d-none"),document.getElementById("userName").focus())}function f(){document.getElementById("userId").value="",document.getElementById("userName").value="",document.getElementById("userEmail").value="",document.getElementById("userMembershipCode").value="",document.getElementById("userPhoneNumber").value="",document.getElementById("userFcmToken").value="",document.getElementById("user-add-btn").classList.remove("d-none"),document.getElementById("user-update-btn").classList.add("d-none"),document.getElementById("user-cancel-btn").classList.add("d-none")}var E;document.getElementById("confirmDeleteUserBtn")?.addEventListener("click",function(){y&&(!async function(t){const n=e();s();try{const e=await fetch("/cms/data-user/delete",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":n},body:JSON.stringify({id:t,_csrf:n})}),d=await e.json();a(),d.success?(c("success","User berhasil dihapus!"),m=m.filter(e=>e.id!==t),l(m),f()):c("error",d.error||"Gagal hapus user")}catch(e){a(),c("error","Terjadi error jaringan atau CSRF.")}}(y),y=null),bootstrap.Modal.getInstance(document.getElementById("deleteUserModal")).hide()}),document.getElementById("user-cancel-btn").addEventListener("click",function(){f()}),document.getElementById("userForm").addEventListener("submit",async function(t){if(t.preventDefault(),!document.getElementById("user-add-btn").classList.contains("d-none")){const t=document.getElementById("userName").value.trim(),n=document.getElementById("userEmail").value.trim();if(!t)return void c("error","Nama tidak boleh kosong!");if(!function(e){return/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(e)}(n))return void c("error","Format email tidak valid!");const d=document.getElementById("userMembershipCode").value.trim(),s=document.getElementById("userPhoneNumber").value.trim(),a=document.getElementById("userFcmToken").value.trim(),u=e();r();try{const e=await fetch("/cms/data-user/add",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":u},body:JSON.stringify({name:t,email:n,membershipCode:d,phoneNumber:s,fcmToken:a,_csrf:u})}),r=await e.json();o(),r.success&&r.user?(c("success","User berhasil ditambahkan!"),m.push(r.user),l(m),f()):c("error",r.error||"Gagal menambah user")}catch(e){o(),c("error","Terjadi error jaringan atau CSRF.")}}}),document.getElementById("user-update-btn").addEventListener("click",async function(){const t=document.getElementById("userId").value,n=document.getElementById("userName").value.trim(),d=document.getElementById("userEmail").value.trim(),s=document.getElementById("userMembershipCode").value.trim(),a=document.getElementById("userPhoneNumber").value.trim(),u=document.getElementById("userFcmToken").value.trim(),i=e();r();try{const e=await fetch("/cms/data-user/edit",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":i},body:JSON.stringify({id:t,name:n,email:d,membershipCode:s,phoneNumber:a,fcmToken:u,_csrf:i})}),r=await e.json();if(o(),r.success&&r.user){c("success","User berhasil diupdate!");const e=m.findIndex(e=>e.id===t);-1!==e&&(m[e]=r.user,l(m)),f()}else c("error",r.error||"Gagal update user")}catch(e){o(),c("error","Terjadi error jaringan atau CSRF.")}}),document.getElementById("user-search-form").addEventListener("submit",function(e){e.preventDefault();const t=document.getElementById("userSearchInput").value.trim().toLowerCase();if(!t)return l(m),void f();const n=m.filter(e=>e.name&&e.name.toLowerCase().includes(t)||e.email&&e.email.toLowerCase().includes(t));l(n),1===n.length?g(n[0].id):f()}),document.getElementById("userSearchResetBtn").addEventListener("click",function(){document.getElementById("userSearchInput").value="",l(m),f()}),r(),fetch("/api/users").then(e=>e.json()).then(e=>{m=e,l(e),o(),E&&E(e)}).catch(()=>{m=[],l([]),o(),E&&E([])}),f()});