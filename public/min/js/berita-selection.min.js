import{getFirestore,collection,addDoc,getDocs,deleteDoc,updateDoc,doc,query,where,orderBy,getDoc}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";import{initializeApp,getApps}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";import*as firebaseConfig from"../../firebase-config.js";let app;app=getApps().length?getApps()[0]:initializeApp(firebaseConfig);const db=getFirestore(app),beritaCollectionRef=collection(db,"berita"),addBeritaForm=document.getElementById("addBeritaForm"),beritaSelection=document.getElementById("berita-selection"),beritaAddBtn=document.getElementById("berita-add-btn"),beritaUpdateBtn=document.getElementById("berita-update-btn"),beritaCancelBtn=document.getElementById("berita-cancel-btn"),beritaMessage=document.getElementById("berita-message");let currentBeritaId=null;function createSlug(e){return e.toLowerCase().trim().replace(/ /g,"-").replace(/[^\w-]+/g,"")}async function isSlugUnique(e,t=null){const a=query(beritaCollectionRef,where("slug","==",e)),n=await getDocs(a);return!!n.empty||!!t&&(1===n.docs.length&&n.docs[0].id===t)}function displayBeritaMessage(e,t="info"){beritaMessage.textContent=e,beritaMessage.className=`alert alert-${t}`,beritaMessage.classList.remove("d-none"),setTimeout(()=>beritaMessage.classList.add("d-none"),5e3)}async function handleBeritaFormSubmit(e){e.preventDefault();const t=document.getElementById("beritaTitle").value,a=document.getElementById("beritaTitleKeterangan").value,n=document.getElementById("beritaTanggalPembuatan").value,i=document.getElementById("beritaContent").value,r=document.getElementById("beritaPhotoUrl").value,d=document.getElementById("beritaCaption").value;currentBeritaId?await updateBerita(currentBeritaId,t,a,n,i,r,d):await addBerita(t,a,n,i,r,d),resetBeritaForm()}function resetBeritaForm(){addBeritaForm.reset(),currentBeritaId=null,beritaAddBtn.classList.remove("d-none"),beritaUpdateBtn.classList.add("d-none"),beritaCancelBtn.classList.add("d-none"),document.getElementById("form-title-berita").innerText="Tambah Berita Baru"}async function fetchBerita(){beritaSelection.innerHTML="";try{const e=query(beritaCollectionRef,orderBy("tanggalPembuatan","desc")),t=await getDocs(e);if(t.empty)return void(beritaSelection.innerHTML="<p>Tidak ada berita yang tersedia.</p>");t.forEach(e=>{const t=e.data();beritaSelection.innerHTML+=generateBeritaCard(e.id,t)}),attachBeritaEventListeners()}catch(e){console.error("Error loading berita:",e),displayBeritaMessage(`Gagal memuat berita: ${e.message}`,"danger")}}function generateBeritaCard(e,t){const a=t.content.length>200?t.content.substring(0,200)+"...":t.content;return`\n        <div class="col-md-4 mb-4">\n            <div class="card h-100">\n                <img src="${t.photoUrl}" class="card-img-top" alt="${t.title}">\n                <div class="card-body d-flex flex-column">\n                    <h5 class="card-title">${t.title}</h5>\n                    <p class="card-text"><strong>${t.titleKeterangan}</strong></p>\n                    <p class="card-text text-muted">${new Date(t.tanggalPembuatan).toLocaleDateString("id-ID")}</p>\n                    <p class="card-text">${a}</p>\n                    <div class="mt-auto">\n                        <a href="/berita-home.html?slug=${t.slug}" class="btn btn-primary">Buka Berita</a>\n                        <button class="btn btn-warning edit-berita-btn mt-2" data-id="${e}">Edit</button>\n                        <button class="btn btn-danger delete-berita-btn mt-2" data-id="${e}">Hapus</button>\n                    </div>\n                </div>\n            </div>\n        </div>`}function attachBeritaEventListeners(){document.querySelectorAll(".edit-berita-btn").forEach(e=>{e.addEventListener("click",()=>editBeritaById(e.dataset.id))}),document.querySelectorAll(".delete-berita-btn").forEach(e=>{e.addEventListener("click",()=>deleteBerita(e.dataset.id))})}async function addBerita(e,t,a,n,i,r){try{const d=createSlug(e);if(!await isSlugUnique(d))throw new Error("Slug sudah digunakan.");await addDoc(beritaCollectionRef,{title:e,titleKeterangan:t,tanggalPembuatan:a,content:n,photoUrl:i,caption:r,slug:d}),displayBeritaMessage("Berita berhasil ditambahkan!","success"),fetchBerita()}catch(e){displayBeritaMessage(`Gagal menambahkan berita: ${e.message}`,"danger")}}async function updateBerita(e,t,a,n,i,r,d){try{const s=createSlug(t);if(!await isSlugUnique(s,e))throw new Error("Slug sudah digunakan.");const o=doc(db,"berita",e);await updateDoc(o,{title:t,titleKeterangan:a,tanggalPembuatan:n,content:i,photoUrl:r,caption:d,slug:s}),displayBeritaMessage("Berita berhasil diperbarui!","success"),fetchBerita()}catch(e){displayBeritaMessage(`Gagal memperbarui berita: ${e.message}`,"danger")}}async function deleteBerita(e){if(confirm("Apakah Anda yakin ingin menghapus berita ini?"))try{await deleteDoc(doc(db,"berita",e)),displayBeritaMessage("Berita berhasil dihapus.","success"),fetchBerita()}catch(e){displayBeritaMessage(`Gagal menghapus berita: ${e.message}`,"danger")}}async function editBeritaById(e){try{const t=await getDoc(doc(db,"berita",e));if(!t.exists())throw new Error("Berita tidak ditemukan.");populateBeritaForm(t.data()),currentBeritaId=e,beritaAddBtn.classList.add("d-none"),beritaUpdateBtn.classList.remove("d-none"),beritaCancelBtn.classList.remove("d-none"),document.getElementById("form-title-berita").innerText="Edit Berita"}catch(e){displayBeritaMessage(`Gagal memuat berita: ${e.message}`,"danger")}}function populateBeritaForm(e){document.getElementById("beritaTitle").value=e.title,document.getElementById("beritaTitleKeterangan").value=e.titleKeterangan,document.getElementById("beritaTanggalPembuatan").value=e.tanggalPembuatan,document.getElementById("beritaContent").value=e.content,document.getElementById("beritaPhotoUrl").value=e.photoUrl,document.getElementById("beritaCaption").value=e.caption}addBeritaForm.addEventListener("submit",handleBeritaFormSubmit),beritaCancelBtn.addEventListener("click",resetBeritaForm),document.addEventListener("DOMContentLoaded",fetchBerita);