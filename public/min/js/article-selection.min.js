import{getFirestore,collection,addDoc,getDocs,deleteDoc,updateDoc,doc,query,where,getDoc}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";import{initializeApp,getApps}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";import*as firebaseConfig from"../../firebase-config.js";let app;app=getApps().length?getApps()[0]:initializeApp(firebaseConfig);const db=getFirestore(app),articleCollectionRef=collection(db,"articles"),addContentForm=document.getElementById("addContentForm"),artikelSelection=document.getElementById("artikel-selection"),addBtn=document.getElementById("add-btn"),updateBtn=document.getElementById("update-btn"),cancelBtn=document.getElementById("cancel-profil-btn"),message=document.getElementById("message");let currentArticleId=null;function createSlug(e){return e.toLowerCase().trim().replace(/ /g,"-").replace(/[^\w-]+/g,"")}async function isSlugUnique(e,t=null){const a=query(articleCollectionRef,where("slug","==",e)),n=await getDocs(a);return!!n.empty||!!t&&(1===n.docs.length&&n.docs[0].id===t)}function displayMessage(e,t="info"){message.textContent=e,message.className=`alert alert-${t}`,message.classList.remove("d-none"),setTimeout(()=>message.classList.add("d-none"),5e3)}async function handleFormSubmit(e){e.preventDefault();const t=document.getElementById("title").value,a=document.getElementById("content").value,n=document.getElementById("photoUrl").value,i=document.getElementById("caption").value,l=document.getElementById("titleKeterangan").value,c=document.getElementById("tanggalPembuatan").value;currentArticleId?await updateArticle(currentArticleId,t,a,n,i,l,c):await addArticle(t,a,n,i,l,c),resetForm()}function resetForm(){addContentForm.reset(),currentArticleId=null,addBtn.classList.remove("d-none"),updateBtn.classList.add("d-none"),cancelBtn.classList.add("d-none"),document.getElementById("form-title").innerText="Tambah Artikel Baru"}async function fetchArticles(){artikelSelection.innerHTML="";try{const e=await getDocs(articleCollectionRef);if(e.empty)return void(artikelSelection.innerHTML="<p>Tidak ada artikel yang tersedia.</p>");e.forEach(e=>{const t=e.data();artikelSelection.innerHTML+=generateArticleCard(e.id,t)}),attachEventListeners()}catch(e){console.error("Error saat memuat daftar artikel:",e),displayMessage(`Gagal memuat artikel: ${e.message}`,"danger")}}function generateArticleCard(e,t){const a=t.content.substring(0,200)+"...";return`\n        <div class="col-md-4 mb-4">\n            <div class="card h-100">\n                <img src="${t.photoUrl}" class="card-img-top" alt="${t.title}">\n                <div class="card-body d-flex flex-column">\n                    <h5 class="card-title">${t.title}</h5>\n                    <p class="card-text"><strong>${t.titleKeterangan}</strong></p>\n                    <p class="card-text text-muted">${new Date(t.tanggalPembuatan).toLocaleDateString("id-ID")}</p>\n                    <p class="card-text">${a}</p>\n                    <div class="mt-auto">\n                        <a href="/artikel-home.html?slug=${t.slug}" class="btn btn-primary">Buka Artikel</a>\n                        <button class="btn btn-warning edit-btn mt-2" data-id="${e}">Edit</button>\n                        <button class="btn btn-danger delete-btn mt-2" data-id="${e}">Hapus</button>\n                    </div>\n                </div>\n            </div>\n        </div>`}function attachEventListeners(){document.querySelectorAll(".edit-btn").forEach(e=>{e.addEventListener("click",()=>editArticleById(e.dataset.id))}),document.querySelectorAll(".delete-btn").forEach(e=>{e.addEventListener("click",()=>deleteArticle(e.dataset.id))})}async function addArticle(e,t,a,n,i,l){try{const c=createSlug(e);if(!await isSlugUnique(c))throw new Error("Slug sudah digunakan.");await addDoc(articleCollectionRef,{title:e,content:t,photoUrl:a,caption:n,titleKeterangan:i,tanggalPembuatan:l,slug:c}),displayMessage("Artikel berhasil ditambahkan!","success"),fetchArticles()}catch(e){displayMessage(`Gagal menambahkan artikel: ${e.message}`,"danger")}}async function updateArticle(e,t,a,n,i,l,c){try{const r=doc(db,"articles",e);await updateDoc(r,{title:t,content:a,photoUrl:n,caption:i,titleKeterangan:l,tanggalPembuatan:c}),displayMessage("Artikel berhasil diperbarui!","success"),fetchArticles()}catch(e){displayMessage(`Gagal memperbarui artikel: ${e.message}`,"danger")}}async function deleteArticle(e){if(confirm("Apakah Anda yakin ingin menghapus artikel ini?"))try{await deleteDoc(doc(db,"articles",e)),displayMessage("Artikel berhasil dihapus.","success"),fetchArticles()}catch(e){displayMessage(`Gagal menghapus artikel: ${e.message}`,"danger")}}async function editArticleById(e){try{const t=await getDoc(doc(db,"articles",e));if(!t.exists())throw new Error("Artikel tidak ditemukan.");populateForm(t.data()),currentArticleId=e,addBtn.classList.add("d-none"),updateBtn.classList.remove("d-none"),cancelBtn.classList.remove("d-none"),document.getElementById("form-title").innerText="Edit Artikel"}catch(e){displayMessage(`Gagal memuat artikel: ${e.message}`,"danger")}}function populateForm(e){document.getElementById("title").value=e.title,document.getElementById("content").value=e.content,document.getElementById("photoUrl").value=e.photoUrl,document.getElementById("caption").value=e.caption,document.getElementById("titleKeterangan").value=e.titleKeterangan,document.getElementById("tanggalPembuatan").value=e.tanggalPembuatan}addContentForm.addEventListener("submit",handleFormSubmit),cancelBtn.addEventListener("click",resetForm),document.addEventListener("DOMContentLoaded",fetchArticles);